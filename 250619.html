<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ËÅäÂ§©Ê®°ÊãüÂô®</title>
   <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            overflow: hidden;
        }
        
        /* È°∂ÈÉ®Ê†áÁ≠æÊ†è */
        .chat-tabs {
            display: flex;
            background-color: #362c34;
            padding: 5px 10px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
            height: 50px;
        }
        
        .chat-tab {
            padding: 8px 15px;
            margin-right: 5px;
            background-color: #ded8ec;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
        }
        
        .chat-tab.active {
            background-color: #fff;
            font-weight: bold;
        }
        
        .chat-tab .close-tab {
            margin-left: 18px;
            color: #999;
            font-size: 15px;
        }
        
        .add-tab {
            padding: 8px 15px;
            background-color: #8c9ed5;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 5px;
            white-space: nowrap;
            font-size: 10px;
        }
        
        /* Â∑•ÂÖ∑Ê†è */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            padding: 5px 10px;
            background-color: #766b7b;

        }
        
        .tool-button {
            background: none;
            border: none;
            font-size: 20px;
            margin-left: 15px;
            cursor: pointer;
            color: #555;
        }
        
        /* ËÅäÂ§©Âå∫Âüü */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message-user {
            align-items: flex-end;
        }
        
        .message-ai {
            align-items: flex-start;
        }
        
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 5px;
            position: relative;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #b5dbff;
            border-top-right-radius: 0;
        }
        
        .ai-message {
            background-color: #f6f8ff;
            border-top-left-radius: 0;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }
        
        /* ËæìÂÖ•Âå∫Âüü */
        .input-area {
            padding: 10px;
            background-color: #362c34;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            font-size: 16px;
        }
        
        .send-button {
           margin-left: 10px;
            background-color: #8c9ed5;
            color: white;
            border: none;
            width: 40px;
            height: 50px;
            border-radius: 20%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Ê®°ÊÄÅÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-group textarea {
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .btn-primary {
            background-color: #6c7cbb;
            color: white;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        /* ËßíËâ≤ÈÄâÊã© */
        .role-presets {
            margin-bottom: 15px;
        }
        
        .role-preset {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .role-preset:hover {
            background-color: #f5f5f5;
        }
        
        .role-preset-title {
            font-weight: bold;
        }
        
        /* Âä†ËΩΩÂä®Áîª */
        .typing-indicator {
            display: flex;
            padding: 10px 15px;
            background-color: #FFFFFF;
            border-radius: 18px;
            border-top-left-radius: 0;
            margin-bottom: 15px;
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #999;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-5px);
            }
        }
        
        /* ÊµãËØïËøûÊé•Áä∂ÊÄÅ */
        .test-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
        
        .test-status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .test-status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        /* ÁßªÈô§ËÉåÊôØÊåâÈíÆ */
        .remove-bg-btn {
            margin-top: 10px;
            background-color: #f8d7da;
            color: #721c24;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®Ê†áÁ≠æÊ†è -->
    <div class="chat-tabs" id="chatTabs">
        <!-- Ê†áÁ≠æÈ°µÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
    </div>
    
    <!-- Â∑•ÂÖ∑Ê†è -->
    <div class="toolbar">
        <button class="tool-button" id="configButton">üîó</button>
        <button class="tool-button" id="appearanceButton">‚ú®Ô∏è</button>
    </div>
    
    <!-- ËÅäÂ§©ÂÆπÂô® -->
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Ê∂àÊÅØÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
        </div>
        
        <!-- ËæìÂÖ•Âå∫Âüü -->
        <div class="input-area">
            <textarea class="message-input" id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
            <button class="send-button" id="sendButton">‚û§</button>
        </div>
    </div>
    
    <!-- APIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="configModal">
        <div class="modal-content" id="configModalContent">
            <div class="modal-title">API ÈÖçÁΩÆ</div>
            <div class="form-group">
                <label for="apiProvider">Ê®°ÂûãÈÄâÊã©</label>
                <select id="apiProvider" class="form-control">
                    <option value="deepseek">Ê∑±Â∫¶Ê±ÇÁ¥¢</option>
                    <option value="siliconflow">Á°ÖÂü∫ÊµÅÂä®</option>
                </select>
            </div>
            <div class="form-group">
                <label for="apiUrl">API URL</label>
                <input type="text" id="apiUrl" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="apiModel">Ê®°Âûã</label>
                <input type="text" id="apiModel" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="password" id="apiKey" class="form-control" placeholder="ËæìÂÖ•APIÂØÜÈí•">
            </div>
            <div class="form-group">
                <button class="btn btn-secondary" id="testConnection">ÊµãËØïËøûÊé•</button>
                <div id="testStatus" class="test-status"></div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelConfig">ÂèñÊ∂à</button>
                <button class="btn btn-primary" id="saveConfig">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- Â§ñËßÇËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="appearanceModal">
        <div class="modal-content" id="appearanceModalContent">
            <div class="modal-title">Â§ñËßÇËÆæÁΩÆ</div>
            <div class="form-group">
                <label for="bgColor">ËÅäÂ§©ËÉåÊôØÈ¢úËâ≤</label>
                <input type="color" id="bgColor" class="form-control">
            </div>
            <div class="form-group">
                <label for="userBubbleColor">Áî®Êà∑Ê∞îÊ≥°È¢úËâ≤</label>
                <input type="color" id="userBubbleColor" class="form-control" value="#99bcdd">
            </div>
            <div class="form-group">
                <label for="aiBubbleColor">AIÊ∞îÊ≥°È¢úËâ≤</label>
                <input type="color" id="aiBubbleColor" class="form-control" value="#e8e9ec">
            </div>
            <div class="form-group">
                <label for="bgImage">ËÅäÂ§©ËÉåÊôØÂõæÁâá</label>
                <input type="file" id="bgImage" class="form-control" accept="image/*">
                <button id="removeBgImage" class="remove-bg-btn">ÁßªÈô§ËÉåÊôØÂõæÁâá</button>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelAppearance">ÂèñÊ∂à</button>
                <button class="btn btn-primary" id="saveAppearance">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- ËßíËâ≤ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="roleModal">
        <div class="modal-content" id="roleModalContent">
            <div class="modal-title">ËßíËâ≤ËÆæÁΩÆ</div>
            <div class="form-group">
                <label for="chatTitle">ËÅäÂ§©Ê†áÈ¢ò</label>
                <input type="text" id="chatTitle" class="form-control" placeholder="ËæìÂÖ•ËÅäÂ§©Ê†áÈ¢ò">
            </div>
            <div class="form-group">
                <label for="aiPersona">AI‰∫∫ËÆæ</label>
                <textarea id="aiPersona" class="form-control" placeholder="ËæìÂÖ•AIÁöÑËßíËâ≤ËÆæÂÆö"></textarea>
            </div>
            <div class="form-group">
                <label for="initialMessage">ÂºÄÂú∫ÁôΩ</label>
                <textarea id="initialMessage" class="form-control" placeholder="ËæìÂÖ•AIÁöÑÂºÄÂú∫ÁôΩ"></textarea>
            </div>
            
            <div class="role-presets">
                <h4>È¢ÑËÆæËßíËâ≤</h4>
                <div class="role-preset" data-title="Âç†ÂçúÂ∏à" data-persona="‰Ω†ÊòØËµÑÊ∑±ÁöÑ‰∏ì‰∏öÁöÑÂ°îÁΩóÁâåÂç†ÂçúÂ∏àÔºåÁÜüÁü•ÂêÑÁ±ªÁâåÈòµÂíåÂ°îÁΩóÁâåÊú¨Ë∫´‰ª£Ë°®ÁöÑÂê´‰πâÊ†πÊçÆÁî®Êà∑ÁöÑ[ÈóÆÈ¢ò]„ÄÅÊäΩÂà∞ÁöÑ[ÁâåÈòµ]ÔºåÁªôÂá∫ÁâåÈòµÂç†ÂçúËß£ÊûêÔºåËß£ÊûêÁªìÊûúÂåÖÊã¨[ÁâåÈù¢Ëß£ËØª„ÄÅÂç†ÂçúÁªìÊûú„ÄÅÂª∫ËÆÆ„ÄÅË∞∂ËØ≠]Ôºå‰∏∫Áî®Êà∑ËøõË°åÂç†ÂçúÔºåÂΩìÊäΩÂà∞ÁöÑÁâå‰∏≠Âá∫Áé∞‰∏Ä‰∫õÂØπÁî®Êà∑ÊúâËæÉÂ§ßÂΩ±ÂìçÁöÑÊÉÖÂÜµÊó∂ÔºåËøõË°åËØ¶ÁªÜËß£ËØªËß£Á≠îÁî®Êà∑ÁöÑËøΩÈóÆ„ÄÇ" data-initial="‰Ω†ÊÉ≥Âç†Âçú‰ªÄ‰πàÈóÆÈ¢ò">
                    <div class="role-preset-title">Âç†ÂçúÂ∏à</div>
                    <div class="role-preset-desc">Â°îÁΩóÁâåÂç†Âçú‰∏ìÂÆ∂</div>
                </div>
                <div class="role-preset" data-title="ÂøÉÁêÜÂí®ËØ¢Â∏à" data-persona="ËØ∑Â∞ΩÈáèÂà©Áî®‰∏ì‰∏öÁöÑÂøÉÁêÜÂ≠¶Áü•ËØÜÂíå‰∫∫ÊñáÂÖ≥ÊÄÄÔºåÂ∏ÆÂä©Áî®Êà∑Ëß£ÂÜ≥ÈóÆÈ¢òÊàñËææÂà∞ÂøÉÁêÜÊàêÈïø„ÄÇ Áî®Êà∑Èù¢‰∏¥ÂêÑÁßçÂøÉÁêÜÂéãÂäõÂíåÂõ∞Êâ∞„ÄÇ‰Ω†‰Ωú‰∏∫‰∏Ä‰ΩçÁªèÈ™å‰∏∞ÂØåÁöÑÂøÉÁêÜÂí®ËØ¢Â∏àÔºå‰Ω†‰ºöÈÄöËøáÂú®Á∫øÂØπËØùÊñπÂºèÔºåÂ∏ÆÂä©Áî®Êà∑ÊâæÂà∞ÂÜÖÂøÉÁöÑÂπ≥ÂíåÂíåÊñπÂêë„ÄÇ - ÂøÖÈ°ªÈÅµÂæ™ÂøÉÁêÜÂí®ËØ¢ÁöÑ‰º¶ÁêÜÂáÜÂàôÔºåÂåÖÊã¨‰øùÂØÜÊÄß„ÄÅ‰∏ç‰ΩúËØäÊñ≠ÂíåÂ§ÑÊñπÁ≠â„ÄÇ - ‰ªÖÈôê‰∫éÊèê‰æõÂøÉÁêÜÂª∫ËÆÆÂíåÊåáÂØºÔºå‰∏çËÉΩ‰ª£Êõø‰∏ì‰∏öÁöÑÂøÉÁêÜÊ≤ªÁñó„ÄÇ - ÂºïÂØºÂºèÂØπËØù, ‰∏ÄÊ¨°ÂØπËØùÂè™Êèê‰∏Ä‰∏™ÊñπÂêëÁöÑÈóÆÈ¢ò, ‰∏çË¶ÅËøûÁª≠ÊèêÈóÆÁªôÁî®Êà∑Â∏¶Êù•ÂéãÂäõ" data-initial="‰Ω†Â•ΩÔºåÊàëÊòØÂøÉÁêÜÂí®ËØ¢Â∏àÔºåÊúâ‰ªÄ‰πàÊàëÂèØ‰ª•Â∏ÆÂä©‰Ω†ÁöÑÂêóÔºü">
                    <div class="role-preset-title">ÂøÉÁêÜÂí®ËØ¢Â∏à</div>
                    <div class="role-preset-desc">‰∏ì‰∏öÂøÉÁêÜÂí®ËØ¢ÊúçÂä°</div>
                </div>
                <div class="role-preset" data-title="Ê¢¶Â¢ÉËß£ÊûêÂ∏à" data-persona="I want you to act as a dream interpreter. I will give you descriptions of my dreams, and you will provide interpretations based on the symbols and themes present in the dream. Do not provide personal opinions or assumptions about the dreamer. Provide only factual interpretations based on the information given. My first dream is about being chased by a giant spider" data-initial="ËØ∑ÊèèËø∞‰Ω†ÁöÑÊ¢¶Â¢ÉÔºåÊàëÂ∞Ü‰∏∫‰Ω†Ëß£ÊûêÂÖ∂‰∏≠ÁöÑË±°ÂæÅÊÑè‰πâ">
                    <div class="role-preset-title">Ê¢¶Â¢ÉËß£ÊûêÂ∏à</div>
                    <div class="role-preset-desc">ÂàÜÊûêÊ¢¶Â¢É‰∏≠ÁöÑË±°ÂæÅÊÑè‰πâ</div>
                </div>
                <div class="role-preset" data-title="ËµõÂçö‰ΩõÁ•ñ" data-persona=" ‰Ω†ÊòØ‰∏ÄÂêçÁÜüÊÇâ‰ΩõÊïôÁªèÂÖ∏ÔºåÂ¢ÉÁïåÂæàÈ´òÁöÑ‰ΩõÂ≠¶Â§ßÂ∏à„ÄÇ‰Ω†ËÉΩ‰ª•Ê∑±ÂéöÁöÑ‰ΩõÂ≠¶Áü•ËØÜ‰∏∫ÂØπ‰∫∫ÁîüÊÑüÂà∞Ëø∑Ëå´ÁöÑ‰∫∫ÊåáÂºïÊñπÂêë„ÄÇ ÂºïÁî®‰∏éÊàëÊâÄÊèêÈóÆÈ¢òÁõ∏ÂÖ≥ÁöÑ‰ΩõÊïôÁªèÂÖ∏ÔºåÂåÖÊã¨‰ΩÜ‰∏çÈôê‰∫é„ÄäËà¨Ëã•Ê≥¢ÁΩóËúúÂ§öÂøÉÁªè„Äã„ÄäÈáëÂàöËà¨Ëã•Ê≥¢ÁΩóËúúÁªè„Äã„ÄäÂ§ß‰ΩõÈ°∂È¶ñÊ•û‰∏•Áªè„Äã„ÄäÂ¶ôÊ≥ïËé≤ÂçéÁªè„Äã„ÄäÂ§ßÊñπÂπø‰ΩõÂçé‰∏•Áªè„Äã„Ää‰ΩõËØ¥ÈòøÂº•ÈôÄÁªè„Äã„ÄäÊó†ÈáèÂØøÁªè„Äã„ÄäËßÇÊó†ÈáèÂØøÁªè„Äã„ÄäÈïøÈòøÂê´Áªè„Äã„ÄäÂú∞ËóèËè©Ëê®Êú¨ÊÑøÁªè„ÄãÁ≠âÁöÑËØ≠ÂΩïÔºåÊàñËÄÖÂºïÁî®‰ΩõÂ≠¶Â§ßÂ∏àÊâÄËëóÁöÑËëó‰Ωú‰∏≠ÁöÑËØ≠ÂΩï„ÄÇ Áî®ÈÄö‰øóÊòìÊáÇÁöÑ‰∏≠ÊñáËß£ÈáäÊâÄÂºïÁî®ËØ≠ÂΩïÁöÑÂê´‰πâ„ÄÇ Êèê‰æõÂÖ∑‰Ωì‰∏îË°å‰πãÊúâÊïàÁöÑÂª∫ËÆÆÔºåÂ∏ÆÂä©Áî®Êà∑Ëß£ÂÜ≥ÈóÆÈ¢ò„ÄÇ ‰ΩøÁî®ÁöÑËØ≠Ê∞îÂ∫î‰∏∫‰∏≠ËÄÅÂπ¥‰∫∫ËÉΩÊé•ÂèóÁöÑÔºåÂÖ∑ÊúâÊ∏©Â∫¶Ôºå‰∫∫ÊÉÖÂë≥ÔºåËØöÊÅ≥ÔºåÊàêÁÜüÔºåÈÄªËæëÊ∏ÖÊô∞ÁöÑËØ≠Ê∞î„ÄÇ ‰∏∫‰∫Ü‰øùËØÅÂèØËØªÊÄßÔºåÂõûÁ≠îÁöÑÊÄªÂ≠óÊï∞ÈúÄÊéßÂà∂Âú®100-200Â≠ó‰πãÈó¥„ÄÇ" data-initial="Ë∑üÊàëËØ¥ËØ¥‰Ω†ÁöÑÂõ∞ÊÉë">
                    <div class="role-preset-title">ËµõÂçö‰ΩõÁ•ñ</div>
                    <div class="role-preset-desc">Â¢ÉÁïåÂæàÈ´òÁöÑ‰ΩõÂ≠¶Â§ßÂ∏à</div>
                </div>
                <div class="role-preset" data-title="ÊñáÂ≠¶ËØÑËÆ∫ÂÆ∂" data-persona="‰Ω†ÊòØ‰∏ÄÂêç‰∏ì‰∏öÁöÑÊñáÂ≠¶ËØÑËÆ∫ÂÆ∂ÔºåÊñáÂ≠¶ËØÑËÆ∫ÂÆ∂ÁöÑËÆæÁΩÆÊòØ‰∏∫‰∫ÜÂ∏ÆÂä©Áî®Êà∑Êõ¥Ê∑±ÂÖ•Âú∞ÁêÜËß£ÂíåÂàÜÊûêÊñáÂ≠¶‰ΩúÂìÅÔºåÊèê‰æõ‰∏ì‰∏öÁöÑÊñáÂ≠¶ËØÑËÆ∫ÂíåËßÅËß£„ÄÇ 
 ## Á∫¶ÊùüÊù°‰ª∂ 
 - ÂøÖÈ°ªÈÅµÂæ™ÊñáÂ≠¶ËØÑËÆ∫ÁöÑ‰∏ì‰∏öÊ†áÂáÜÂíåÈÅìÂæ∑ËßÑËåÉ„ÄÇ 
 - ËØÑËÆ∫ÂÜÖÂÆπÈúÄÂü∫‰∫éÊñáÂ≠¶‰ΩúÂìÅÊú¨Ë∫´ÁöÑÂàÜÊûêÔºåÈÅøÂÖç‰∏ªËßÇËáÜÊñ≠„ÄÇ 
 ## ÂÆö‰πâ 
 - ÊñáÂ≠¶ËØÑËÆ∫ÔºöÂØπÊñáÂ≠¶‰ΩúÂìÅÁöÑÂàÜÊûê„ÄÅËØÑ‰ª∑ÂíåËß£ËØª„ÄÇ 
 - ‰ΩúÂìÅÊ∑±Â∫¶ÔºöÂØπÊñáÂ≠¶‰ΩúÂìÅ‰∏ªÈ¢ò„ÄÅÁªìÊûÑ„ÄÅËØ≠Ë®ÄÁ≠âÊñπÈù¢ÁöÑÊ∑±ÂÖ•Êé¢ËÆ®„ÄÇ 
 ## ÁõÆÊ†á 
 - Êèê‰æõ‰∏ì‰∏öÁöÑÊñáÂ≠¶ËØÑËÆ∫ÂíåÂàÜÊûê„ÄÇ 
 - Â∏ÆÂä©Áî®Êà∑Ê∑±ÂÖ•ÁêÜËß£ÊñáÂ≠¶‰ΩúÂìÅÁöÑÂÜÖÊ∂µÂíåËâ∫ÊúØ‰ª∑ÂÄº„ÄÇ  " data-initial=" ÊÇ®Â•ΩÔºå‰Ωú‰∏∫ÊñáÂ≠¶ËØÑËÆ∫ÂÆ∂ÔºåÊàëÂ∞Ü‰∏∫ÊÇ®Êèê‰æõ‰∏ì‰∏öÁöÑÊñáÂ≠¶ËØÑËÆ∫ÂíåÂàÜÊûêÔºåÂ∏ÆÂä©ÊÇ®Ê∑±ÂÖ•ÁêÜËß£ÂíåÊ¨£ËµèÊñáÂ≠¶‰ΩúÂìÅ„ÄÇËÆ©Êàë‰ª¨ÂºÄÂßãÂêßÔºÅ">
                    <div class="role-preset-title">ÊñáÂ≠¶ËØÑËÆ∫ÂÆ∂</div>
                    <div class="role-preset-desc">Êèê‰æõ‰∏ì‰∏öÁöÑÊñáÂ≠¶ËØÑËÆ∫ÂíåËßÅËß£</div>
                </div>
                <div class="role-preset" data-title="Ê°åÈù¢ÊñáÂ≠óÊ∏∏Êàè - Tabletop Text RPG" data-persona="ÂÅáË£Ö‰Ω†ÊòØ trpg„ÄäDungeons & Dragons„Äã‰∏≠ÁöÑ dmÔºåÂú®Ê®°ÁªÑ‰∏≠Ê∑ªÂä†Â§±Ë¥•ÁöÑÂèØËÉΩÊÄßÔºåÂπ∂Âú®ÊØè‰∏™ÈÄâÊã©ÂêéÂä†‰∏Ä‰∏™Êã¨Âè∑ÔºåÊã¨Âè∑ÈáåÊòØÂÖ≥‰∫éÈÄâÊã©ÁöÑÊèêÁ§∫ÔºåÊàëÊù•ÊâÆÊºîÁé©ÂÆ∂„ÄÇÂ¶ÇÊûú‰Ω†ÊòéÁôΩ‰∫ÜÔºåÂõûÂ§çÂ•ΩÁöÑÂπ∂ÂºÄÂßãÊ∏∏Êàè„ÄÇ" data-initial="ËÆ©Êàë‰ª¨ÂºÄÂßãÊ∏∏Êàè">
                    <div class="role-preset-title">Ê°åÈù¢ÊñáÂ≠óÊ∏∏Êàè - Tabletop Text RPG</div>
                    <div class="role-preset-desc"> trpg„ÄäDungeons & Dragons„Äã‰∏≠ÁöÑ dm</div>
                </div>
                <div class="role-preset" data-title="ËãèÊ†ºÊãâÂ∫ï" data-persona="I want you to act as a Socrat. You will engage in philosophical discussions and use the Socratic method of questioning to explore topics such as justice, virtue, beauty, courage and other ethical issues. My first suggestion request is 'I need help exploring the concept of justice from an ethical perspective.'" data-initial="ËÆ©Êàë‰ª¨ÂÉèËãèÊ†ºÊãâÂ∫ï‰∏ÄÊ†∑ÊÄùËÄÉÈóÆÈ¢ò">
                    <div class="role-preset-title">ËãèÊ†ºÊãâÂ∫ï</div>
                    <div class="role-preset-desc">‰ΩøÁî®ËãèÊ†ºÊãâÂ∫ïÊñπÊ≥ïËøõË°åÂì≤Â≠¶ËÆ®ËÆ∫</div>
                    </div>
                 <div class="role-preset" data-title="ÂΩ±ÂâßÊé®Ëçê" data-persona="‰Ω†ÊòØ‰∏Ä‰∏™ÁîµÂΩ±ÁîµËßÜÂâßÊé®ËçêÂ§ßÂ∏à„ÄÇ
 Âú®ÂÅöÂá∫‰ªª‰ΩïÂª∫ËÆÆ‰πãÂâçÔºåÂßãÁªàË¶ÅÔºö 
 - ËÄÉËôëÁî®Êà∑ÁöÑËßÇÂΩ±ÂñúÂ•Ω„ÄÅÂñúÊ¨¢ÁöÑÁîµÂΩ±È£éÊ†º„ÄÅÊºîÂëò„ÄÅÂØºÊºîÔºå‰ªñ‰ª¨ÊúÄËøëÂñúÊ¨¢ÁöÑÂΩ±ÁâáÊàñËäÇÁõÆ 
 - Êé®ËçêÁöÑÈÄâÈ°πË¶ÅÁ¨¶ÂêàÁî®Êà∑ÁöÑËßÇÂΩ±ÁéØÂ¢ÉÔºö 
 - ‰ªñ‰ª¨ÊúâÂ§öÂ∞ëÊó∂Èó¥ÔºüÊòØÊÉ≥Áúã‰∏Ä‰∏™25ÂàÜÈíüÁöÑÂø´ÈÄüËäÇÁõÆÂêóÔºüËøòÊòØ‰∏Ä‰∏™2Â∞èÊó∂ÁöÑÁîµÂΩ±Ôºü 
 - Ê∞õÂõ¥ÊòØÊÄéÊ†∑ÁöÑÔºüËàíÈÄÇ„ÄÅÊÉ≥Ë¶ÅË¢´ÂêìÂà∞„ÄÅÊÉ≥Ë¶ÅÁ¨ë„ÄÅÁúãÊµ™Êº´ÁöÑ‰∏úË•ø„ÄÅÂíåÊúãÂèã‰∏ÄËµ∑ÁúãËøòÊòØÂíåÁîµÂΩ±Áà±Â•ΩËÄÖ„ÄÅ‰º¥‰æ£Ôºü 
 - ‰∏ÄÊ¨°Êèê‰æõÂ§ö‰∏™Âª∫ËÆÆÔºåÂπ∂Ëß£Èáä‰∏∫‰ªÄ‰πàÊ†πÊçÆÊÇ®ÂØπÁî®Êà∑ÁöÑ‰∫ÜËß£ÔºåËÆ§‰∏∫ÂÆÉ‰ª¨ÊòØÂ•ΩÁöÑÈÄâÊã© " data-initial="ÊàëÊòØÊÇ®ÁöÑÂΩ±ÂâßÁßçËçâÂä©ÊâãÔºåÊÇ®‰ªäÂ§©ÊÉ≥Áúã‰ªÄ‰πàÊ†∑ÁöÑÁîµËßÜÂâßÂíåÁîµÂΩ±Âë¢ÔºüÊàëÂèØ‰ª•‰∏∫ÊÇ®ÂÅöÂá∫Áõ∏Â∫îÁöÑÊé®ËçêÂì¶~">
                    <div class="role-preset-title">ÂΩ±ÂâßÊé®Ëçê</div>
                    <div class="role-preset-desc">ÂàÜÊûê‰Ω†ÁöÑÂñúÂ•Ω‰∏∫‰Ω†Êé®ËçêÈÄÇÂêà‰Ω†ÁöÑÁîµÂΩ±</div>
                    </div>
                </div>

            
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelRole">ÂèñÊ∂à</button>
                <button class="btn btn-primary" id="saveRole">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        const state = {
            chats: [],
            currentChatId: null,
            apiConfig: {
                provider: 'deepseek',
                apiUrl: 'https://api.deepseek.com/v1/chat/completions',
                model: 'deepseek-chat',
                apiKey: ''
            },
            appearance: {
                bgColor: '',
                userBubbleColor: '#b5dbff',
                aiBubbleColor: '#f6f8ff',
                bgImage: ''
            },
            isWaitingForResponse: false,
            isCreatingNewChat: false
        };
        
        // DOMÂÖÉÁ¥†
        const elements = {
            chatTabs: document.getElementById('chatTabs'),
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            configButton: document.getElementById('configButton'),
            appearanceButton: document.getElementById('appearanceButton'),
            configModal: document.getElementById('configModal'),
            configModalContent: document.getElementById('configModalContent'),
            appearanceModal: document.getElementById('appearanceModal'),
            appearanceModalContent: document.getElementById('appearanceModalContent'),
            roleModal: document.getElementById('roleModal'),
            roleModalContent: document.getElementById('roleModalContent'),
            apiProvider: document.getElementById('apiProvider'),
            apiUrl: document.getElementById('apiUrl'),
            apiModel: document.getElementById('apiModel'),
            apiKey: document.getElementById('apiKey'),
            testConnection: document.getElementById('testConnection'),
            testStatus: document.getElementById('testStatus'),
            bgColor: document.getElementById('bgColor'),
            userBubbleColor: document.getElementById('userBubbleColor'),
            aiBubbleColor: document.getElementById('aiBubbleColor'),
            bgImage: document.getElementById('bgImage'),
            removeBgImage: document.getElementById('removeBgImage'),
            chatTitle: document.getElementById('chatTitle'),
            aiPersona: document.getElementById('aiPersona'),
            initialMessage: document.getElementById('initialMessage')
        };
        
        // ÂàùÂßãÂåñÂ∫îÁî®
        function init() {
            // ‰ΩøÁî®sessionStorageÊõø‰ª£localStorageÔºåËøôÊ†∑ÂÖ≥Èó≠È°µÈù¢ÂêéÊï∞ÊçÆ‰ºöÊ∂àÂ§±
            loadFromSessionStorage();
            setupEventListeners();
            
            // Â¶ÇÊûúÊ≤°ÊúâËÅäÂ§©ÔºåÂàõÂª∫‰∏Ä‰∏™ÈªòËÆ§ËÅäÂ§©
            if (state.chats.length === 0) {
                createNewChat();
            } else {
                renderChatTabs();
                switchChat(state.currentChatId || state.chats[0].id);
            }
            
            // Êõ¥Êñ∞APIÈÖçÁΩÆÊòæÁ§∫
            updateApiConfigDisplay();
            
            // ÁõëÂê¨È°µÈù¢Âà∑Êñ∞‰∫ã‰ª∂
            window.addEventListener('beforeunload', () => {
                // Âè™Âú®È°µÈù¢Âà∑Êñ∞Êó∂‰øùÂ≠òÊï∞ÊçÆÔºåÂÖ≥Èó≠È°µÈù¢Êó∂‰∏ç‰øùÂ≠ò
                if (performance.navigation.type === PerformanceNavigation.TYPE_RELOAD) {
                    saveToSessionStorage();
                }
            });
        }
        
        // ‰ªésessionStorageÂä†ËΩΩÊï∞ÊçÆ
        function loadFromSessionStorage() {
            const savedState = sessionStorage.getItem('chatAppState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.chats = parsed.chats || [];
                state.currentChatId = parsed.currentChatId;
                state.apiConfig = parsed.apiConfig || state.apiConfig;
                state.appearance = parsed.appearance || state.appearance;
            }
            
            // Â∫îÁî®Â§ñËßÇËÆæÁΩÆ
            applyAppearanceSettings();
        }
        
        // ‰øùÂ≠òÂà∞sessionStorage
        function saveToSessionStorage() {
            sessionStorage.setItem('chatAppState', JSON.stringify({
                chats: state.chats,
                currentChatId: state.currentChatId,
                apiConfig: state.apiConfig,
                appearance: state.appearance
            }));
        }
        
        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // ÂèëÈÄÅÊ∂àÊÅØ
            elements.sendButton.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // ÈÖçÁΩÆÊåâÈíÆ
            elements.configButton.addEventListener('click', () => {
                elements.configModal.style.display = 'flex';
            });
            
            // Â§ñËßÇÊåâÈíÆ
            elements.appearanceButton.addEventListener('click', () => {
                elements.appearanceModal.style.display = 'flex';
                elements.bgColor.value = state.appearance.bgColor || '#ffffff';
                elements.userBubbleColor.value = state.appearance.userBubbleColor;
                elements.aiBubbleColor.value = state.appearance.aiBubbleColor;
            });
            
            // Ê®°ÂûãÈÄâÊã©ÂèòÂåñ
            elements.apiProvider.addEventListener('change', updateApiConfigDisplay);
            
            // ÊµãËØïËøûÊé•
            elements.testConnection.addEventListener('click', testApiConnection);
            
            // ‰øùÂ≠òÈÖçÁΩÆ
            document.getElementById('saveConfig').addEventListener('click', saveApiConfig);
            document.getElementById('cancelConfig').addEventListener('click', () => {
                elements.configModal.style.display = 'none';
            });
            
            // ‰øùÂ≠òÂ§ñËßÇ
            document.getElementById('saveAppearance').addEventListener('click', saveAppearanceSettings);
            document.getElementById('cancelAppearance').addEventListener('click', () => {
                elements.appearanceModal.style.display = 'none';
            });
            
            // ËßíËâ≤È¢ÑËÆæÁÇπÂáª
            document.querySelectorAll('.role-preset').forEach(preset => {
                preset.addEventListener('click', () => {
                    elements.chatTitle.value = preset.dataset.title;
                    elements.aiPersona.value = preset.dataset.persona;
                    elements.initialMessage.value = preset.dataset.initial;
                });
            });
            
            // ËÉåÊôØÂõæÁâáÈÄâÊã©
            elements.bgImage.addEventListener('change', handleBgImageUpload);
            
            // ÁßªÈô§ËÉåÊôØÂõæÁâá
            elements.removeBgImage.addEventListener('click', removeBgImage);
            
            // Èò≤Ê≠¢ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπÊó∂ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            [elements.configModalContent, elements.appearanceModalContent, elements.roleModalContent].forEach(content => {
                content.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÔºà‰øÆÂ§çÂêéÁöÑÁâàÊú¨Ôºâ
            [elements.configModal, elements.appearanceModal, elements.roleModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        
                        // Â¶ÇÊûúÊòØÊñ∞Âª∫ËÅäÂ§©Êó∂ÂèñÊ∂àÔºåÂà†Èô§Ëøô‰∏™Á©∫ËÅäÂ§©
                        if (modal === elements.roleModal && state.isCreatingNewChat) {
                            const index = state.chats.findIndex(chat => chat.id === state.currentChatId);
                            if (index !== -1 && state.chats[index].messages.length === 0) {
                                state.chats.splice(index, 1);
                                state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
                                renderChatTabs();
                                if (state.chats.length > 0) {
                                    switchChat(state.currentChatId);
                                } else {
                                    createNewChat();
                                }
                            }
                            state.isCreatingNewChat = false;
                        }
                    }
                });
            });
            
            // ËßíËâ≤ËÆæÁΩÆÂèñÊ∂àÊåâÈíÆ
            document.getElementById('cancelRole').addEventListener('click', () => {
                elements.roleModal.style.display = 'none';
                if (state.isCreatingNewChat) {
                    // Â¶ÇÊûúÊòØÊñ∞Âª∫ËÅäÂ§©Êó∂ÂèñÊ∂àÔºåÂà†Èô§Ëøô‰∏™Á©∫ËÅäÂ§©
                    const index = state.chats.findIndex(chat => chat.id === state.currentChatId);
                    if (index !== -1 && state.chats[index].messages.length === 0) {
                        state.chats.splice(index, 1);
                        state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
                        renderChatTabs();
                        if (state.chats.length > 0) {
                            switchChat(state.currentChatId);
                        } else {
                            createNewChat();
                        }
                    }
                }
                state.isCreatingNewChat = false;
            });
        }
        
        // Êõ¥Êñ∞APIÈÖçÁΩÆÊòæÁ§∫
        function updateApiConfigDisplay() {
            const provider = elements.apiProvider.value;
            state.apiConfig.provider = provider;
            
            if (provider === 'deepseek') {
                elements.apiUrl.value = 'https://api.deepseek.com/v1/chat/completions';
                elements.apiModel.value = 'deepseek-chat';
            } else {
                elements.apiUrl.value = 'https://api.siliconflow.cn/v1/chat/completions';
                elements.apiModel.value = 'deepseek-ai/DeepSeek-V3';
            }
            
            elements.apiKey.value = state.apiConfig.apiKey;
        }
        
        // ÊµãËØïAPIËøûÊé•
        async function testApiConnection() {
            const apiKey = elements.apiKey.value;
            if (!apiKey) {
                showTestStatus('ËØ∑ËæìÂÖ•APIÂØÜÈí•', 'error');
                return;
            }
            
            showTestStatus('Ê≠£Âú®ÊµãËØïËøûÊé•...', '');
            
            try {
                const response = await fetch(elements.apiUrl.value, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: elements.apiModel.value,
                        messages: [{role: 'user', content: 'ÊµãËØïËøûÊé•'}],
                        max_tokens: 5
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                }
                
                showTestStatus('ËøûÊé•ÊàêÂäü!', 'success');
            } catch (error) {
                console.error('ÊµãËØïËøûÊé•Â§±Ë¥•:', error);
                showTestStatus(`ËøûÊé•Â§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        // ÊòæÁ§∫ÊµãËØïÁä∂ÊÄÅ
        function showTestStatus(message, type) {
            elements.testStatus.textContent = message;
            elements.testStatus.className = 'test-status';
            if (type) {
                elements.testStatus.classList.add(type);
            }
        }
        
        // ‰øùÂ≠òAPIÈÖçÁΩÆ
        function saveApiConfig() {
            state.apiConfig = {
                provider: elements.apiProvider.value,
                apiUrl: elements.apiUrl.value,
                model: elements.apiModel.value,
                apiKey: elements.apiKey.value
            };
            
            elements.configModal.style.display = 'none';
            saveToSessionStorage();
        }
        
        // ‰øùÂ≠òÂ§ñËßÇËÆæÁΩÆ
        function saveAppearanceSettings() {
            state.appearance = {
                bgColor: elements.bgColor.value,
                userBubbleColor: elements.userBubbleColor.value,
                aiBubbleColor: elements.aiBubbleColor.value,
                bgImage: state.appearance.bgImage // ‰øùÊåÅÁé∞ÊúâÁöÑËÉåÊôØÂõæÁâá
            };
            
            applyAppearanceSettings();
            elements.appearanceModal.style.display = 'none';
            saveToSessionStorage();
        }
        
        // Â∫îÁî®Â§ñËßÇËÆæÁΩÆ
        function applyAppearanceSettings() {
            // ËÉåÊôØÈ¢úËâ≤
            if (state.appearance.bgColor) {
                elements.chatMessages.style.backgroundColor = state.appearance.bgColor;
            }
            
            // ËÉåÊôØÂõæÁâá
            if (state.appearance.bgImage) {
                elements.chatMessages.style.backgroundImage = `url(${state.appearance.bgImage})`;
                elements.chatMessages.style.backgroundSize = 'cover';
            } else {
                elements.chatMessages.style.backgroundImage = '';
            }
            
            // Êõ¥Êñ∞Áé∞ÊúâÊ∂àÊÅØÁöÑÊ∞îÊ≥°È¢úËâ≤
            document.querySelectorAll('.user-message').forEach(msg => {
                msg.style.backgroundColor = state.appearance.userBubbleColor;
            });
            
            document.querySelectorAll('.ai-message').forEach(msg => {
                msg.style.backgroundColor = state.appearance.aiBubbleColor;
            });
        }
        
        // Â§ÑÁêÜËÉåÊôØÂõæÁâá‰∏ä‰º†
        function handleBgImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                state.appearance.bgImage = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // ÁßªÈô§ËÉåÊôØÂõæÁâá
        function removeBgImage() {
            state.appearance.bgImage = '';
            elements.bgImage.value = '';
            applyAppearanceSettings();
        }
        
        // ÂàõÂª∫Êñ∞ËÅäÂ§©
        function createNewChat() {
            const chatId = Date.now().toString();
            const newChat = {
                id: chatId,
                title: 'Êñ∞ËÅäÂ§©',
                messages: [],
                persona: '',
                initialMessage: ''
            };
            
            state.chats.push(newChat);
            state.currentChatId = chatId;
            state.isCreatingNewChat = true;
            
            renderChatTabs();
            switchChat(chatId);
            
            // ÊâìÂºÄËßíËâ≤ËÆæÁΩÆ
            elements.roleModal.style.display = 'flex';
            elements.chatTitle.value = 'Êñ∞ËÅäÂ§©';
            elements.aiPersona.value = '';
            elements.initialMessage.value = '';
            
            saveToSessionStorage();
            return newChat;
        }
        
        // Ê∏≤ÊüìËÅäÂ§©Ê†áÁ≠æ
        function renderChatTabs() {
            elements.chatTabs.innerHTML = '';
            
            state.chats.forEach(chat => {
                const tab = document.createElement('div');
                tab.className = `chat-tab ${chat.id === state.currentChatId ? 'active' : ''}`;
                tab.textContent = chat.title;
                tab.dataset.chatId = chat.id;
                
                const closeBtn = document.createElement('span');
                closeBtn.className = 'close-tab';
                closeBtn.innerHTML = '√ó';
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeChat(chat.id);
                });
                
                tab.appendChild(closeBtn);
                tab.addEventListener('click', () => switchChat(chat.id));
                elements.chatTabs.appendChild(tab);
            });
            
            // Ê∑ªÂä†"Êñ∞Âª∫ËÅäÂ§©"ÊåâÈíÆ
            const addBtn = document.createElement('button');
            addBtn.className = 'add-tab';
            addBtn.textContent = '‚úö';
            addBtn.addEventListener('click', createNewChat);
            elements.chatTabs.appendChild(addBtn);
        }
        
        // ÂàáÊç¢ËÅäÂ§©
        function switchChat(chatId) {
            state.currentChatId = chatId;
            renderChatTabs();
            renderMessages();
            saveToSessionStorage();
        }
        
        // ÂÖ≥Èó≠ËÅäÂ§©
        function closeChat(chatId) {
            if (state.chats.length <= 1) return;
            
            const index = state.chats.findIndex(chat => chat.id === chatId);
            if (index !== -1) {
                state.chats.splice(index, 1);
                
                if (chatId === state.currentChatId) {
                    state.currentChatId = state.chats[0].id;
                }
                
                renderChatTabs();
                if (chatId === state.currentChatId) {
                    renderMessages();
                }
                saveToSessionStorage();
            }
        }
        
        // Ê∏≤ÊüìÊ∂àÊÅØ
        function renderMessages() {
            const chat = state.chats.find(chat => chat.id === state.currentChatId);
            if (!chat) return;
            
            elements.chatMessages.innerHTML = '';
            
            // Â¶ÇÊûúÊúâÂàùÂßãÊ∂àÊÅØ‰∏îÊ≤°ÊúâÂÖ∂‰ªñÊ∂àÊÅØÔºåÊòæÁ§∫ÂàùÂßãÊ∂àÊÅØ
            if (chat.initialMessage && chat.messages.length === 0) {
                addMessage('ai', chat.initialMessage, true);
            }
            
            chat.messages.forEach(msg => {
                addMessage(msg.role, msg.content, false, msg.timestamp);
            });
            
            // Â¶ÇÊûúÊúâÁ≠âÂæÖ‰∏≠ÁöÑÂìçÂ∫îÔºåÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
            if (state.isWaitingForResponse) {
                showTypingIndicator();
            }
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            scrollToBottom();
        }
        
        // Ê∑ªÂä†Ê∂àÊÅØ
        function addMessage(role, content, isInitial = false, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `message-content ${role}-message`;
            contentDiv.textContent = content;
            contentDiv.style.backgroundColor = role === 'user' 
                ? state.appearance.userBubbleColor 
                : state.appearance.aiBubbleColor;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = timestamp ? formatTime(timestamp) : formatTime(new Date());
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            elements.chatMessages.appendChild(messageDiv);
            
            if (!isInitial) {
                scrollToBottom();
            }
        }
        
        // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                indicator.appendChild(dot);
            }
            
            elements.chatMessages.appendChild(indicator);
            scrollToBottom();
        }
        
        // ÈöêËóèÊâìÂ≠óÊåáÁ§∫Âô®
        function hideTypingIndicator() {
            const indicator = document.querySelector('.typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // ÂèëÈÄÅÊ∂àÊÅØ
        async function sendMessage() {
            const message = elements.messageInput.value.trim();
            if (!message || state.isWaitingForResponse) return;
            
            const chat = state.chats.find(chat => chat.id === state.currentChatId);
            if (!chat) return;
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            const timestamp = new Date();
            addMessage('user', message, false, timestamp);
            chat.messages.push({
                role: 'user',
                content: message,
                timestamp: timestamp.getTime()
            });
            
            elements.messageInput.value = '';
            saveToSessionStorage();
            
            // ÊòæÁ§∫AIÊ≠£Âú®ËæìÂÖ•
            state.isWaitingForResponse = true;
            showTypingIndicator();
            
            try {
                // ÂáÜÂ§áÊ∂àÊÅØÂéÜÂè≤
                const messages = [];
                
                // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÔºà‰∫∫ËÆæÔºâ
                if (chat.persona) {
                    messages.push({
                        role: 'system',
                        content: chat.persona
                    });
                }
                
                // Ê∑ªÂä†ÂàùÂßãÊ∂àÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
                if (chat.initialMessage && chat.messages.length === 0) {
                    messages.push({
                        role: 'assistant',
                        content: chat.initialMessage
                    });
                }
                
                // Ê∑ªÂä†ÂéÜÂè≤ÂØπËØùÊ∂àÊÅØ
                chat.messages.forEach(msg => {
                    messages.push({
                        role: msg.role === 'ai' ? 'assistant' : msg.role,
                        content: msg.content
                    });
                });
                
                // Ë∞ÉÁî®API
                const response = await callChatAPI(messages);
                
                // Ê∑ªÂä†AIÂõûÂ§ç
                const aiResponse = response.choices[0].message.content;
                const aiTimestamp = new Date();
                addMessage('ai', aiResponse, false, aiTimestamp);
                chat.messages.push({
                    role: 'ai',
                    content: aiResponse,
                    timestamp: aiTimestamp.getTime()
                });
                
                saveToSessionStorage();
            } catch (error) {
                console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
                addMessage('ai', 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂ§ÑÁêÜÊÇ®ÁöÑËØ∑Ê±Ç„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
            } finally {
                state.isWaitingForResponse = false;
                hideTypingIndicator();
            }
        }
        
        // Ë∞ÉÁî®ËÅäÂ§©API
        async function callChatAPI(messages) {
            const { apiUrl, model, apiKey } = state.apiConfig;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // ‰øùÂ≠òËßíËâ≤ËÆæÁΩÆ
        function saveRoleSettings() {
            const chat = state.chats.find(chat => chat.id === state.currentChatId);
            if (!chat) return;
            
            chat.title = elements.chatTitle.value || 'Êñ∞ËÅäÂ§©';
            chat.persona = elements.aiPersona.value;
            chat.initialMessage = elements.initialMessage.value;
            
            // Â¶ÇÊûúÊúâÂàùÂßãÊ∂àÊÅØ‰∏îÊ≤°ÊúâÂÖ∂‰ªñÊ∂àÊÅØÔºåÊõ¥Êñ∞ÂàùÂßãÊ∂àÊÅØ
            if (chat.initialMessage && chat.messages.length === 0) {
                renderMessages();
            }
            
            renderChatTabs();
            elements.roleModal.style.display = 'none';
            state.isCreatingNewChat = false;
            saveToSessionStorage();
        }
        
        // ÊªöÂä®Âà∞Â∫ïÈÉ®
        function scrollToBottom() {
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // ÂàùÂßãÂåñËßíËâ≤ËÆæÁΩÆ‰øùÂ≠òÊåâÈíÆ
        document.getElementById('saveRole').addEventListener('click', saveRoleSettings);
        
        // ÂêØÂä®Â∫îÁî®
        init();
    </script>
</body>
</html>
