<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èŠå¤©æ¨¡æ‹Ÿå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            overflow: hidden;
        }
        
        /* é¡¶éƒ¨æ ‡ç­¾æ  */
        .chat-tabs {
            display: flex;
            background-color: #362c34;
            padding: 5px 10px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
            height: 50px;
        }
        
        .chat-tab {
            padding: 8px 15px;
            margin-right: 5px;
            background-color: #ded8ec;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
        }
        
        .chat-tab.active {
            background-color: #fff;
            font-weight: bold;
        }
        
        .chat-tab .close-tab {
            margin-left: 18px;
            color: #999;
            font-size: 15px;
        }
        
        .add-tab {
            padding: 8px 15px;
            background-color: #8c9ed5;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 5px;
            white-space: nowrap;
            font-size: 10px;
        }
        
        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            padding: 5px 10px;
            background-color: #766b7b;

        }
        
        .tool-button {
            background: none;
            border: none;
            font-size: 20px;
            margin-left: 15px;
            cursor: pointer;
            color: #555;
        }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message-user {
            align-items: flex-end;
        }
        
        .message-ai {
            align-items: flex-start;
        }
        
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 5px;
            position: relative;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #b5dbff;
            border-top-right-radius: 0;
        }
        
        .ai-message {
            background-color: #f6f8ff;
            border-top-left-radius: 0;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 10px;
            background-color: #362c34;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            font-size: 16px;
        }
        
        .send-button {
           margin-left: 10px;
            background-color: #8c9ed5;
            color: white;
            border: none;
            width: 40px;
            height: 50px;
            border-radius: 20%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-group textarea {
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .btn-primary {
            background-color: #6c7cbb;
            color: white;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        /* è§’è‰²é€‰æ‹© */
        .role-presets {
            margin-bottom: 15px;
        }
        
        .role-preset {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .role-preset:hover {
            background-color: #f5f5f5;
        }
        
        .role-preset-title {
            font-weight: bold;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: flex;
            padding: 10px 15px;
            background-color: #FFFFFF;
            border-radius: 18px;
            border-top-left-radius: 0;
            margin-bottom: 15px;
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #999;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-5px);
            }
        }
        
        /* æµ‹è¯•è¿æ¥çŠ¶æ€ */
        .test-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
        
        .test-status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .test-status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        /* ç§»é™¤èƒŒæ™¯æŒ‰é’® */
        .remove-bg-btn {
            margin-top: 10px;
            background-color: #f8d7da;
            color: #721c24;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ ‡ç­¾æ  -->
    <div class="chat-tabs" id="chatTabs">
        <!-- æ ‡ç­¾é¡µå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
       <!-- <button class="tool-button " id="configButton">ğŸ”—</button>-->
        <button class="tool-button" id="appearanceButton">âœ¨ï¸</button>
    </div>
    
    <!-- èŠå¤©å®¹å™¨ -->
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-area">
            <textarea class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
            <button class="send-button" id="sendButton">â¤</button>
        </div>
    </div>
    
    <!-- APIé…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="configModal">
        <div class="modal-content" id="configModalContent">
            <div class="modal-title">API é…ç½®</div>
            <div class="form-group">
                <label for="apiProvider">æ¨¡å‹é€‰æ‹©</label>
                <select id="apiProvider" class="form-control">
                    <option value="deepseek">ç¡…åŸºæµåŠ¨</option>
                    <option value="siliconflow">æ·±åº¦æ±‚ç´¢</option>
                </select>
            </div>
            <div class="form-group">
                <label for="apiUrl">API URL</label>
                <input type="text" id="apiUrl" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="apiModel">æ¨¡å‹</label>
                <input type="text" id="apiModel" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="password" id="apiKey" class="form-control" placeholder="è¾“å…¥APIå¯†é’¥">
            </div>
            <div class="form-group">
                <button class="btn btn-secondary" id="testConnection">æµ‹è¯•è¿æ¥</button>
                <div id="testStatus" class="test-status"></div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelConfig">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveConfig">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- å¤–è§‚è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="appearanceModal">
        <div class="modal-content" id="appearanceModalContent">
            <div class="modal-title">å¤–è§‚è®¾ç½®</div>
            <div class="form-group">
                <label for="bgColor">èŠå¤©èƒŒæ™¯é¢œè‰²</label>
                <input type="color" id="bgColor" class="form-control">
            </div>
            <div class="form-group">
                <label for="userBubbleColor">ç”¨æˆ·æ°”æ³¡é¢œè‰²</label>
                <input type="color" id="userBubbleColor" class="form-control" value="#99bcdd">
            </div>
            <div class="form-group">
                <label for="aiBubbleColor">AIæ°”æ³¡é¢œè‰²</label>
                <input type="color" id="aiBubbleColor" class="form-control" value="#e8e9ec">
            </div>
            <div class="form-group">
                <label for="bgImage">èŠå¤©èƒŒæ™¯å›¾ç‰‡</label>
                <input type="file" id="bgImage" class="form-control" accept="image/*">
                <button id="removeBgImage" class="remove-bg-btn">ç§»é™¤èƒŒæ™¯å›¾ç‰‡</button>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelAppearance">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveAppearance">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- è§’è‰²è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="roleModal">
        <div class="modal-content" id="roleModalContent">
            <div class="modal-title">è§’è‰²è®¾ç½®</div>
            <div class="form-group">
                <label for="chatTitle">èŠå¤©æ ‡é¢˜</label>
                <input type="text" id="chatTitle" class="form-control" placeholder="è¾“å…¥èŠå¤©æ ‡é¢˜">
            </div>
            <div class="form-group">
                <label for="aiPersona">AIäººè®¾</label>
                <textarea id="aiPersona" class="form-control" placeholder="è¾“å…¥AIçš„è§’è‰²è®¾å®š"></textarea>
            </div>
            <div class="form-group">
                <label for="initialMessage">å¼€åœºç™½</label>
                <textarea id="initialMessage" class="form-control" placeholder="è¾“å…¥AIçš„å¼€åœºç™½"></textarea>
            </div>
            
            <div class="role-presets">
                <h4>é¢„è®¾è§’è‰²</h4>
                <div class="role-preset" data-title="å åœå¸ˆ" data-persona="ä½ æ˜¯èµ„æ·±çš„ä¸“ä¸šçš„å¡”ç½—ç‰Œå åœå¸ˆï¼Œç†ŸçŸ¥å„ç±»ç‰Œé˜µå’Œå¡”ç½—ç‰Œæœ¬èº«ä»£è¡¨çš„å«ä¹‰æ ¹æ®ç”¨æˆ·çš„[é—®é¢˜]ã€æŠ½åˆ°çš„[ç‰Œé˜µ]ï¼Œç»™å‡ºç‰Œé˜µå åœè§£æï¼Œè§£æç»“æœåŒ…æ‹¬[ç‰Œé¢è§£è¯»ã€å åœç»“æœã€å»ºè®®ã€è°¶è¯­]ï¼Œä¸ºç”¨æˆ·è¿›è¡Œå åœï¼Œå½“æŠ½åˆ°çš„ç‰Œä¸­å‡ºç°ä¸€äº›å¯¹ç”¨æˆ·æœ‰è¾ƒå¤§å½±å“çš„æƒ…å†µæ—¶ï¼Œè¿›è¡Œè¯¦ç»†è§£è¯»è§£ç­”ç”¨æˆ·çš„è¿½é—®ã€‚" data-initial="ä½ æƒ³å åœä»€ä¹ˆé—®é¢˜">
                    <div class="role-preset-title">å åœå¸ˆ</div>
                    <div class="role-preset-desc">å¡”ç½—ç‰Œå åœä¸“å®¶</div>
                </div>
                <div class="role-preset" data-title="å¿ƒç†å’¨è¯¢å¸ˆ" data-persona="è¯·å°½é‡åˆ©ç”¨ä¸“ä¸šçš„å¿ƒç†å­¦çŸ¥è¯†å’Œäººæ–‡å…³æ€€ï¼Œå¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜æˆ–è¾¾åˆ°å¿ƒç†æˆé•¿ã€‚ ç”¨æˆ·é¢ä¸´å„ç§å¿ƒç†å‹åŠ›å’Œå›°æ‰°ã€‚ä½ ä½œä¸ºä¸€ä½ç»éªŒä¸°å¯Œçš„å¿ƒç†å’¨è¯¢å¸ˆï¼Œä½ ä¼šé€šè¿‡åœ¨çº¿å¯¹è¯æ–¹å¼ï¼Œå¸®åŠ©ç”¨æˆ·æ‰¾åˆ°å†…å¿ƒçš„å¹³å’Œå’Œæ–¹å‘ã€‚ - å¿…é¡»éµå¾ªå¿ƒç†å’¨è¯¢çš„ä¼¦ç†å‡†åˆ™ï¼ŒåŒ…æ‹¬ä¿å¯†æ€§ã€ä¸ä½œè¯Šæ–­å’Œå¤„æ–¹ç­‰ã€‚ - ä»…é™äºæä¾›å¿ƒç†å»ºè®®å’ŒæŒ‡å¯¼ï¼Œä¸èƒ½ä»£æ›¿ä¸“ä¸šçš„å¿ƒç†æ²»ç–—ã€‚ - å¼•å¯¼å¼å¯¹è¯, ä¸€æ¬¡å¯¹è¯åªæä¸€ä¸ªæ–¹å‘çš„é—®é¢˜, ä¸è¦è¿ç»­æé—®ç»™ç”¨æˆ·å¸¦æ¥å‹åŠ›" data-initial="ä½ å¥½ï¼Œæˆ‘æ˜¯å¿ƒç†å’¨è¯¢å¸ˆï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ">
                    <div class="role-preset-title">å¿ƒç†å’¨è¯¢å¸ˆ</div>
                    <div class="role-preset-desc">ä¸“ä¸šå¿ƒç†å’¨è¯¢æœåŠ¡</div>
                </div>
                <div class="role-preset" data-title="æ¢¦å¢ƒè§£æå¸ˆ" data-persona="I want you to act as a dream interpreter. I will give you descriptions of my dreams, and you will provide interpretations based on the symbols and themes present in the dream. Do not provide personal opinions or assumptions about the dreamer. Provide only factual interpretations based on the information given. My first dream is about being chased by a giant spider" data-initial="è¯·æè¿°ä½ çš„æ¢¦å¢ƒï¼Œæˆ‘å°†ä¸ºä½ è§£æå…¶ä¸­çš„è±¡å¾æ„ä¹‰">
                    <div class="role-preset-title">æ¢¦å¢ƒè§£æå¸ˆ</div>
                    <div class="role-preset-desc">åˆ†ææ¢¦å¢ƒä¸­çš„è±¡å¾æ„ä¹‰</div>
                </div>
                <div class="role-preset" data-title="èµ›åšä½›ç¥–" data-persona=" ä½ æ˜¯ä¸€åç†Ÿæ‚‰ä½›æ•™ç»å…¸ï¼Œå¢ƒç•Œå¾ˆé«˜çš„ä½›å­¦å¤§å¸ˆã€‚ä½ èƒ½ä»¥æ·±åšçš„ä½›å­¦çŸ¥è¯†ä¸ºå¯¹äººç”Ÿæ„Ÿåˆ°è¿·èŒ«çš„äººæŒ‡å¼•æ–¹å‘ã€‚ å¼•ç”¨ä¸æˆ‘æ‰€æé—®é¢˜ç›¸å…³çš„ä½›æ•™ç»å…¸ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºã€Šèˆ¬è‹¥æ³¢ç½—èœœå¤šå¿ƒç»ã€‹ã€Šé‡‘åˆšèˆ¬è‹¥æ³¢ç½—èœœç»ã€‹ã€Šå¤§ä½›é¡¶é¦–æ¥ä¸¥ç»ã€‹ã€Šå¦™æ³•è²åç»ã€‹ã€Šå¤§æ–¹å¹¿ä½›åä¸¥ç»ã€‹ã€Šä½›è¯´é˜¿å¼¥é™€ç»ã€‹ã€Šæ— é‡å¯¿ç»ã€‹ã€Šè§‚æ— é‡å¯¿ç»ã€‹ã€Šé•¿é˜¿å«ç»ã€‹ã€Šåœ°è—è©è¨æœ¬æ„¿ç»ã€‹ç­‰çš„è¯­å½•ï¼Œæˆ–è€…å¼•ç”¨ä½›å­¦å¤§å¸ˆæ‰€è‘—çš„è‘—ä½œä¸­çš„è¯­å½•ã€‚ ç”¨é€šä¿—æ˜“æ‡‚çš„ä¸­æ–‡è§£é‡Šæ‰€å¼•ç”¨è¯­å½•çš„å«ä¹‰ã€‚ æä¾›å…·ä½“ä¸”è¡Œä¹‹æœ‰æ•ˆçš„å»ºè®®ï¼Œå¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚ ä½¿ç”¨çš„è¯­æ°”åº”ä¸ºä¸­è€å¹´äººèƒ½æ¥å—çš„ï¼Œå…·æœ‰æ¸©åº¦ï¼Œäººæƒ…å‘³ï¼Œè¯šæ³ï¼Œæˆç†Ÿï¼Œé€»è¾‘æ¸…æ™°çš„è¯­æ°”ã€‚ ä¸ºäº†ä¿è¯å¯è¯»æ€§ï¼Œå›ç­”çš„æ€»å­—æ•°éœ€æ§åˆ¶åœ¨100-200å­—ä¹‹é—´ã€‚" data-initial="è·Ÿæˆ‘è¯´è¯´ä½ çš„å›°æƒ‘">
                    <div class="role-preset-title">èµ›åšä½›ç¥–</div>
                    <div class="role-preset-desc">å¢ƒç•Œå¾ˆé«˜çš„ä½›å­¦å¤§å¸ˆ</div>
                </div>
                <div class="role-preset" data-title="æ–‡å­¦è¯„è®ºå®¶" data-persona="ä½ æ˜¯ä¸€åä¸“ä¸šçš„æ–‡å­¦è¯„è®ºå®¶ï¼Œæ–‡å­¦è¯„è®ºå®¶çš„è®¾ç½®æ˜¯ä¸ºäº†å¸®åŠ©ç”¨æˆ·æ›´æ·±å…¥åœ°ç†è§£å’Œåˆ†ææ–‡å­¦ä½œå“ï¼Œæä¾›ä¸“ä¸šçš„æ–‡å­¦è¯„è®ºå’Œè§è§£ã€‚ 
 ## çº¦æŸæ¡ä»¶ 
 - å¿…é¡»éµå¾ªæ–‡å­¦è¯„è®ºçš„ä¸“ä¸šæ ‡å‡†å’Œé“å¾·è§„èŒƒã€‚ 
 - è¯„è®ºå†…å®¹éœ€åŸºäºæ–‡å­¦ä½œå“æœ¬èº«çš„åˆ†æï¼Œé¿å…ä¸»è§‚è‡†æ–­ã€‚ 
 ## å®šä¹‰ 
 - æ–‡å­¦è¯„è®ºï¼šå¯¹æ–‡å­¦ä½œå“çš„åˆ†æã€è¯„ä»·å’Œè§£è¯»ã€‚ 
 - ä½œå“æ·±åº¦ï¼šå¯¹æ–‡å­¦ä½œå“ä¸»é¢˜ã€ç»“æ„ã€è¯­è¨€ç­‰æ–¹é¢çš„æ·±å…¥æ¢è®¨ã€‚ 
 ## ç›®æ ‡ 
 - æä¾›ä¸“ä¸šçš„æ–‡å­¦è¯„è®ºå’Œåˆ†æã€‚ 
 - å¸®åŠ©ç”¨æˆ·æ·±å…¥ç†è§£æ–‡å­¦ä½œå“çš„å†…æ¶µå’Œè‰ºæœ¯ä»·å€¼ã€‚  " data-initial=" æ‚¨å¥½ï¼Œä½œä¸ºæ–‡å­¦è¯„è®ºå®¶ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„æ–‡å­¦è¯„è®ºå’Œåˆ†æï¼Œå¸®åŠ©æ‚¨æ·±å…¥ç†è§£å’Œæ¬£èµæ–‡å­¦ä½œå“ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼">
                    <div class="role-preset-title">æ–‡å­¦è¯„è®ºå®¶</div>
                    <div class="role-preset-desc">æä¾›ä¸“ä¸šçš„æ–‡å­¦è¯„è®ºå’Œè§è§£</div>
                </div>
                <div class="role-preset" data-title="æ¡Œé¢æ–‡å­—æ¸¸æˆ - Tabletop Text RPG" data-persona="å‡è£…ä½ æ˜¯ trpgã€ŠDungeons & Dragonsã€‹ä¸­çš„ dmï¼Œåœ¨æ¨¡ç»„ä¸­æ·»åŠ å¤±è´¥çš„å¯èƒ½æ€§ï¼Œå¹¶åœ¨æ¯ä¸ªé€‰æ‹©ååŠ ä¸€ä¸ªæ‹¬å·ï¼Œæ‹¬å·é‡Œæ˜¯å…³äºé€‰æ‹©çš„æç¤ºï¼Œæˆ‘æ¥æ‰®æ¼”ç©å®¶ã€‚å¦‚æœä½ æ˜ç™½äº†ï¼Œå›å¤å¥½çš„å¹¶å¼€å§‹æ¸¸æˆã€‚" data-initial="è®©æˆ‘ä»¬å¼€å§‹æ¸¸æˆ">
                    <div class="role-preset-title">æ¡Œé¢æ–‡å­—æ¸¸æˆ - Tabletop Text RPG</div>
                    <div class="role-preset-desc"> trpgã€ŠDungeons & Dragonsã€‹ä¸­çš„ dm</div>
                </div>
                <div class="role-preset" data-title="è‹æ ¼æ‹‰åº•" data-persona="I want you to act as a Socrat. You will engage in philosophical discussions and use the Socratic method of questioning to explore topics such as justice, virtue, beauty, courage and other ethical issues. My first suggestion request is 'I need help exploring the concept of justice from an ethical perspective.'" data-initial="è®©æˆ‘ä»¬åƒè‹æ ¼æ‹‰åº•ä¸€æ ·æ€è€ƒé—®é¢˜">
                    <div class="role-preset-title">è‹æ ¼æ‹‰åº•</div>
                    <div class="role-preset-desc">ä½¿ç”¨è‹æ ¼æ‹‰åº•æ–¹æ³•è¿›è¡Œå“²å­¦è®¨è®º</div>
                    </div>
                 <div class="role-preset" data-title="å½±å‰§æ¨è" data-persona="ä½ æ˜¯ä¸€ä¸ªç”µå½±ç”µè§†å‰§æ¨èå¤§å¸ˆã€‚
 åœ¨åšå‡ºä»»ä½•å»ºè®®ä¹‹å‰ï¼Œå§‹ç»ˆè¦ï¼š 
 - è€ƒè™‘ç”¨æˆ·çš„è§‚å½±å–œå¥½ã€å–œæ¬¢çš„ç”µå½±é£æ ¼ã€æ¼”å‘˜ã€å¯¼æ¼”ï¼Œä»–ä»¬æœ€è¿‘å–œæ¬¢çš„å½±ç‰‡æˆ–èŠ‚ç›® 
 - æ¨èçš„é€‰é¡¹è¦ç¬¦åˆç”¨æˆ·çš„è§‚å½±ç¯å¢ƒï¼š 
 - ä»–ä»¬æœ‰å¤šå°‘æ—¶é—´ï¼Ÿæ˜¯æƒ³çœ‹ä¸€ä¸ª25åˆ†é’Ÿçš„å¿«é€ŸèŠ‚ç›®å—ï¼Ÿè¿˜æ˜¯ä¸€ä¸ª2å°æ—¶çš„ç”µå½±ï¼Ÿ 
 - æ°›å›´æ˜¯æ€æ ·çš„ï¼Ÿèˆ’é€‚ã€æƒ³è¦è¢«å“åˆ°ã€æƒ³è¦ç¬‘ã€çœ‹æµªæ¼«çš„ä¸œè¥¿ã€å’Œæœ‹å‹ä¸€èµ·çœ‹è¿˜æ˜¯å’Œç”µå½±çˆ±å¥½è€…ã€ä¼´ä¾£ï¼Ÿ 
 - ä¸€æ¬¡æä¾›å¤šä¸ªå»ºè®®ï¼Œå¹¶è§£é‡Šä¸ºä»€ä¹ˆæ ¹æ®æ‚¨å¯¹ç”¨æˆ·çš„äº†è§£ï¼Œè®¤ä¸ºå®ƒä»¬æ˜¯å¥½çš„é€‰æ‹© " data-initial="æˆ‘æ˜¯æ‚¨çš„å½±å‰§ç§è‰åŠ©æ‰‹ï¼Œæ‚¨ä»Šå¤©æƒ³çœ‹ä»€ä¹ˆæ ·çš„ç”µè§†å‰§å’Œç”µå½±å‘¢ï¼Ÿæˆ‘å¯ä»¥ä¸ºæ‚¨åšå‡ºç›¸åº”çš„æ¨èå“¦~">
                    <div class="role-preset-title">å½±å‰§æ¨è</div>
                    <div class="role-preset-desc">åˆ†æä½ çš„å–œå¥½ä¸ºä½ æ¨èé€‚åˆä½ çš„ç”µå½±</div>
                    </div>
                </div>

            
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelRole">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveRole">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€çŠ¶æ€
        const state = {
            chats: [],
            currentChatId: null,
            apiConfig: {
                provider: 'siliconflow',
                apiUrl: 'https://api.siliconflow.cn/v1/chat/completions',
                model: 'deepseek-ai/DeepSeek-V3',
                apiKey: 'sk-sbpvlztkwcjgfzudaflwvfzsylglmdbvthsyolbeanzihwge'
            },
            appearance: {
                bgColor: '',
                userBubbleColor: '#b5dbff',
                aiBubbleColor: '#f6f8ff',
                bgImage: ''
            },
            isWaitingForResponse: false,
            isCreatingNewChat: false
        };
        
        // DOMå…ƒç´ 
        const elements = {
            chatTabs: document.getElementById('chatTabs'),
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            configButton: document.getElementById('configButton'),
            appearanceButton: document.getElementById('appearanceButton'),
            configModal: document.getElementById('configModal'),
            configModalContent: document.getElementById('configModalContent'),
            appearanceModal: document.getElementById('appearanceModal'),
            appearanceModalContent: document.getElementById('appearanceModalContent'),
            roleModal: document.getElementById('roleModal'),
            roleModalContent: document.getElementById('roleModalContent'),
            apiProvider: document.getElementById('apiProvider'),
            apiUrl: document.getElementById('apiUrl'),
            apiModel: document.getElementById('apiModel'),
            apiKey: document.getElementById('apiKey'),
            testConnection: document.getElementById('testConnection'),
            testStatus: document.getElementById('testStatus'),
            bgColor: document.getElementById('bgColor'),
            userBubbleColor: document.getElementById('userBubbleColor'),
            aiBubbleColor: document.getElementById('aiBubbleColor'),
            bgImage: document.getElementById('bgImage'),
            removeBgImage: document.getElementById('removeBgImage'),
            chatTitle: document.getElementById('chatTitle'),
            aiPersona: document.getElementById('aiPersona'),
            initialMessage: document.getElementById('initialMessage')
        };
        
        // åˆå§‹åŒ–åº”ç”¨
        function init() {
            // ä½¿ç”¨sessionStorageæ›¿ä»£localStorageï¼Œè¿™æ ·å…³é—­é¡µé¢åæ•°æ®ä¼šæ¶ˆå¤±
            loadFromSessionStorage();
            setupEventListeners();
            
            // å¦‚æœæ²¡æœ‰èŠå¤©ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤èŠå¤©
            if (state.chats.length === 0) {
                createNewChat();
            } else {
                renderChatTabs();
                switchChat(state.currentChatId || state.chats[0].id);
            }
            
            // æ›´æ–°APIé…ç½®æ˜¾ç¤º
            updateApiConfigDisplay();
            
            // ç›‘å¬é¡µé¢åˆ·æ–°äº‹ä»¶
            window.addEventListener('beforeunload', () => {
                // åªåœ¨é¡µé¢åˆ·æ–°æ—¶ä¿å­˜æ•°æ®ï¼Œå…³é—­é¡µé¢æ—¶ä¸ä¿å­˜
                if (performance.navigation.type === PerformanceNavigation.TYPE_RELOAD) {
                    saveToSessionStorage();
                }
            });
        }
        
        // ä»sessionStorageåŠ è½½æ•°æ®
        function loadFromSessionStorage() {
            const savedState = sessionStorage.getItem('chatAppState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.chats = parsed.chats || [];
                state.currentChatId = parsed.currentChatId;
                state.apiConfig = parsed.apiConfig || state.apiConfig;
                state.appearance = parsed.appearance || state.appearance;
            }
            
            // åº”ç”¨å¤–è§‚è®¾ç½®
            applyAppearanceSettings();
        }
        
        // ä¿å­˜åˆ°sessionStorage
        function saveToSessionStorage() {
            sessionStorage.setItem('chatAppState', JSON.stringify({
                chats: state.chats,
                currentChatId: state.currentChatId,
                apiConfig: state.apiConfig,
                appearance: state.appearance
            }));
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å‘é€æ¶ˆæ¯
            elements.sendButton.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // é…ç½®æŒ‰é’®
        /* elements.configButton.addEventListener('click', () => {
                elements.configModal.style.display = 'flex';
            }); */
            
            // å¤–è§‚æŒ‰é’®
            elements.appearanceButton.addEventListener('click', () => {
                elements.appearanceModal.style.display = 'flex';
                elements.bgColor.value = state.appearance.bgColor || '#ffffff';
                elements.userBubbleColor.value = state.appearance.userBubbleColor;
                elements.aiBubbleColor.value = state.appearance.aiBubbleColor;
            });
            
            // æ¨¡å‹é€‰æ‹©å˜åŒ–
            elements.apiProvider.addEventListener('change', updateApiConfigDisplay);
            
            // æµ‹è¯•è¿æ¥
            elements.testConnection.addEventListener('click', testApiConnection);
            
            // ä¿å­˜é…ç½®
            document.getElementById('saveConfig').addEventListener('click', saveApiConfig);
            document.getElementById('cancelConfig').addEventListener('click', () => {
                elements.configModal.style.display = 'none';
            });
            
            // ä¿å­˜å¤–è§‚
            document.getElementById('saveAppearance').addEventListener('click', saveAppearanceSettings);
            document.getElementById('cancelAppearance').addEventListener('click', () => {
                elements.appearanceModal.style.display = 'none';
            });
            
            // è§’è‰²é¢„è®¾ç‚¹å‡»
            document.querySelectorAll('.role-preset').forEach(preset => {
                preset.addEventListener('click', () => {
                    elements.chatTitle.value = preset.dataset.title;
                    elements.aiPersona.value = preset.dataset.persona;
                    elements.initialMessage.value = preset.dataset.initial;
                });
            });
            
            // èƒŒæ™¯å›¾ç‰‡é€‰æ‹©
            elements.bgImage.addEventListener('change', handleBgImageUpload);
            
            // ç§»é™¤èƒŒæ™¯å›¾ç‰‡
            elements.removeBgImage.addEventListener('click', removeBgImage);
            
            // é˜²æ­¢ç‚¹å‡»æ¨¡æ€æ¡†å†…å®¹æ—¶å…³é—­æ¨¡æ€æ¡†
            [elements.configModalContent, elements.appearanceModalContent, elements.roleModalContent].forEach(content => {
                content.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†ï¼ˆä¿®å¤åçš„ç‰ˆæœ¬ï¼‰
            [elements.configModal, elements.appearanceModal, elements.roleModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        
                        // å¦‚æœæ˜¯æ–°å»ºèŠå¤©æ—¶å–æ¶ˆï¼Œåˆ é™¤è¿™ä¸ªç©ºèŠå¤©
                        if (modal === elements.roleModal && state.isCreatingNewChat) {
                            const index = state.chats.findIndex(chat => chat.id === state.currentChatId);
                            if (index !== -1 && state.chats[index].messages.length === 0) {
                                state.chats.splice(index, 1);
                                state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
                                renderChatTabs();
                                if (state.chats.length > 0) {
                                    switchChat(state.currentChatId);
                                } else {
                                    createNewChat();
                                }
                            }
                            state.isCreatingNewChat = false;
                        }
                    }
                });
            });
            
            // è§’è‰²è®¾ç½®å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelRole').addEventListener('click', () => {
                elements.roleModal.style.display = 'none';
                if (state.isCreatingNewChat) {
                    // å¦‚æœæ˜¯æ–°å»ºèŠå¤©æ—¶å–æ¶ˆï¼Œåˆ é™¤è¿™ä¸ªç©ºèŠå¤©
                    const index = state.chats.findIndex(chat => chat.id === state.currentChatId);
                    if (index !== -1 && state.chats[index].messages.length === 0) {
                        state.chats.splice(index, 1);
                        state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
                        renderChatTabs();
                        if (state.chats.length > 0) {
                            switchChat(state.currentChatId);
                        } else {
                            createNewChat();
                        }
                    }
                }
                state.isCreatingNewChat = false;
            });
        }
        
        // æ›´æ–°APIé…ç½®æ˜¾ç¤º
        function updateApiConfigDisplay() {
            const provider = elements.apiProvider.value;
            state.apiConfig.provider = provider;
            
            if (provider === 'deepseek') {
                elements.apiUrl.value = 'https://api.deepseek.com/v1/chat/completions';
                elements.apiModel.value = 'deepseek-chat';
                 elements.apiKey.value = 'sk-9c2f8a13c8a14e0897591ddf996b36b3'; 
            } else {
                elements.apiUrl.value = 'https://api.siliconflow.cn/v1/chat/completions';
                elements.apiModel.value = 'deepseek-ai/DeepSeek-V3';
                elements.apiKey.value = 'sk-sbpvlztkwcjgfzudaflwvfzsylglmdbvthsyolbeanzihwge'; 
            }
             elements.apiKey.readOnly = true;
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const apiKey = elements.apiKey.value;
            if (!apiKey) {
                showTestStatus('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }
            
            showTestStatus('æ­£åœ¨æµ‹è¯•è¿æ¥...', '');
            
            try {
                const response = await fetch(elements.apiUrl.value, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: elements.apiModel.value,
                        messages: [{role: 'user', content: 'æµ‹è¯•è¿æ¥'}],
                        max_tokens: 5
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                showTestStatus('è¿æ¥æˆåŠŸ!', 'success');
            } catch (error) {
                console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
                showTestStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ˜¾ç¤ºæµ‹è¯•çŠ¶æ€
        function showTestStatus(message, type) {
            elements.testStatus.textContent = message;
            elements.testStatus.className = 'test-status';
            if (type) {
                elements.testStatus.classList.add(type);
            }
        }
        
        // ä¿å­˜APIé…ç½®
        function saveApiConfig() {
            state.apiConfig = {
                provider: elements.apiProvider.value,
                apiUrl: elements.apiUrl.value,
                model: elements.apiModel.value,
                apiKey: elements.apiKey.value
            };
            
            elements.configModal.style.display = 'none';
            saveToSessionStorage();
        }
        
        // ä¿å­˜å¤–è§‚è®¾ç½®
        function saveAppearanceSettings() {
            state.appearance = {
                bgColor: elements.bgColor.value,
                userBubbleColor: elements.userBubbleColor.value,
                aiBubbleColor: elements.aiBubbleColor.value,
                bgImage: state.appearance.bgImage // ä¿æŒç°æœ‰çš„èƒŒæ™¯å›¾ç‰‡
            };
            
            applyAppearanceSettings();
            elements.appearanceModal.style.display = 'none';
            saveToSessionStorage();
        }
        
        // åº”ç”¨å¤–è§‚è®¾ç½®
        function applyAppearanceSettings() {
            // èƒŒæ™¯é¢œè‰²
            if (state.appearance.bgColor) {
                elements.chatMessages.style.backgroundColor = state.appearance.bgColor;
            }
            
            // èƒŒæ™¯å›¾ç‰‡
            if (state.appearance.bgImage) {
                elements.chatMessages.style.backgroundImage = `url(${state.appearance.bgImage})`;
                elements.chatMessages.style.backgroundSize = 'cover';
            } else {
                elements.chatMessages.style.backgroundImage = '';
            }
            
            // æ›´æ–°ç°æœ‰æ¶ˆæ¯çš„æ°”æ³¡é¢œè‰²
            document.querySelectorAll('.user-message').forEach(msg => {
                msg.style.backgroundColor = state.appearance.userBubbleColor;
            });
            
            document.querySelectorAll('.ai-message').forEach(msg => {
                msg.style.backgroundColor = state.appearance.aiBubbleColor;
            });
        }
        
        // å¤„ç†èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ 
        function handleBgImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                state.appearance.bgImage = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // ç§»é™¤èƒŒæ™¯å›¾ç‰‡
        function removeBgImage() {
            state.appearance.bgImage = '';
            elements.bgImage.value = '';
            applyAppearanceSettings();
        }
        
        // åˆ›å»ºæ–°èŠå¤©
        function createNewChat() {
            const chatId = Date.now().toString();
            const newChat = {
                id: chatId,
                title: 'æ–°èŠå¤©',
                messages: [],
                persona: '',
                initialMessage: ''
            };
            
            state.chats.push(newChat);
            state.currentChatId = chatId;
            state.isCreatingNewChat = true;
            
            renderChatTabs();
            switchChat(chatId);
            
            // æ‰“å¼€è§’è‰²è®¾ç½®
            elements.roleModal.style.display = 'flex';
            elements.chatTitle.value = 'æ–°èŠå¤©';
            elements.aiPersona.value = '';
            elements.initialMessage.value = '';
            
            saveToSessionStorage();
            return newChat;
        }
        
        // æ¸²æŸ“èŠå¤©æ ‡ç­¾
        function renderChatTabs() {
            elements.chatTabs.innerHTML = '';
            
            state.chats.forEach(chat => {
                const tab = document.createElement('div');
                tab.className = `chat-tab ${chat.id === state.currentChatId ? 'active' : ''}`;
                tab.textContent = chat.title;
                tab.dataset.chatId = chat.id;
                
                const closeBtn = document.createElement('span');
                closeBtn.className = 'close-tab';
                closeBtn.innerHTML = 'Ã—';
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeChat(chat.id);
                });
                
                tab.appendChild(closeBtn);
                tab.addEventListener('click', () => switchChat(chat.id));
                elements.chatTabs.appendChild(tab);
            });
            
            // æ·»åŠ "æ–°å»ºèŠå¤©"æŒ‰é’®
            const addBtn = document.createElement('button');
            addBtn.className = 'add-tab';
            addBtn.textContent = 'âœš';
            addBtn.addEventListener('click', createNewChat);
            elements.chatTabs.appendChild(addBtn);
        }
        
        // åˆ‡æ¢èŠå¤©
        function switchChat(chatId) {
            state.currentChatId = chatId;
            renderChatTabs();
            renderMessages();
            saveToSessionStorage();
        }
        
        // å…³é—­èŠå¤©
        function closeChat(chatId) {
            if (state.chats.length <= 1) return;
            
            const index = state.chats.findIndex(chat => chat.id === chatId);
            if (index !== -1) {
                state.chats.splice(index, 1);
                
                if (chatId === state.currentChatId) {
                    state.currentChatId = state.chats[0].id;
                }
                
                renderChatTabs();
                if (chatId === state.currentChatId) {
                    renderMessages();
                }
                saveToSessionStorage();
            }
        }
        
        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages() {
            const chat = state.chats.find(chat => chat.id === state.currentChatId);
            if (!chat) return;
            
            elements.chatMessages.innerHTML = '';
            
            // å¦‚æœæœ‰åˆå§‹æ¶ˆæ¯ä¸”æ²¡æœ‰å…¶ä»–æ¶ˆæ¯ï¼Œæ˜¾ç¤ºåˆå§‹æ¶ˆæ¯
            if (chat.initialMessage && chat.messages.length === 0) {
                addMessage('ai', chat.initialMessage, true);
            }
            
            chat.messages.forEach(msg => {
                addMessage(msg.role, msg.content, false, msg.timestamp);
            });
            
            // å¦‚æœæœ‰ç­‰å¾…ä¸­çš„å“åº”ï¼Œæ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
            if (state.isWaitingForResponse) {
                showTypingIndicator();
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }
        
        // æ·»åŠ æ¶ˆæ¯
        function addMessage(role, content, isInitial = false, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `message-content ${role}-message`;
            contentDiv.textContent = content;
            contentDiv.style.backgroundColor = role === 'user' 
                ? state.appearance.userBubbleColor 
                : state.appearance.aiBubbleColor;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = timestamp ? formatTime(timestamp) : formatTime(new Date());
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            elements.chatMessages.appendChild(messageDiv);
            
            if (!isInitial) {
                scrollToBottom();
            }
        }
        
        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                indicator.appendChild(dot);
            }
            
            elements.chatMessages.appendChild(indicator);
            scrollToBottom();
        }
        
        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.querySelector('.typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = elements.messageInput.value.trim();
            if (!message || state.isWaitingForResponse) return;
            
            const chat = state.chats.find(chat => chat.id === state.currentChatId);
            if (!chat) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const timestamp = new Date();
            addMessage('user', message, false, timestamp);
            chat.messages.push({
                role: 'user',
                content: message,
                timestamp: timestamp.getTime()
            });
            
            elements.messageInput.value = '';
            saveToSessionStorage();
            
            // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
            state.isWaitingForResponse = true;
            showTypingIndicator();
            
            try {
                // å‡†å¤‡æ¶ˆæ¯å†å²
                const messages = [];
                
                // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼ˆäººè®¾ï¼‰
                if (chat.persona) {
                    messages.push({
                        role: 'system',
                        content: chat.persona
                    });
                }
                
                // æ·»åŠ åˆå§‹æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if (chat.initialMessage && chat.messages.length === 0) {
                    messages.push({
                        role: 'assistant',
                        content: chat.initialMessage
                    });
                }
                
                // æ·»åŠ å†å²å¯¹è¯æ¶ˆæ¯
                chat.messages.forEach(msg => {
                    messages.push({
                        role: msg.role === 'ai' ? 'assistant' : msg.role,
                        content: msg.content
                    });
                });
                
                // è°ƒç”¨API
                const response = await callChatAPI(messages);
                
                // æ·»åŠ AIå›å¤
                const aiResponse = response.choices[0].message.content;
                const aiTimestamp = new Date();
                addMessage('ai', aiResponse, false, aiTimestamp);
                chat.messages.push({
                    role: 'ai',
                    content: aiResponse,
                    timestamp: aiTimestamp.getTime()
                });
                
                saveToSessionStorage();
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                addMessage('ai', 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å¤„ç†æ‚¨çš„è¯·æ±‚ã€‚è¯·ç¨åå†è¯•ã€‚');
            } finally {
                state.isWaitingForResponse = false;
                hideTypingIndicator();
            }
        }
        
        // è°ƒç”¨èŠå¤©API
        async function callChatAPI(messages) {
            const { apiUrl, model, apiKey } = state.apiConfig;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // ä¿å­˜è§’è‰²è®¾ç½®
        function saveRoleSettings() {
            const chat = state.chats.find(chat => chat.id === state.currentChatId);
            if (!chat) return;
            
            chat.title = elements.chatTitle.value || 'æ–°èŠå¤©';
            chat.persona = elements.aiPersona.value;
            chat.initialMessage = elements.initialMessage.value;
            
            // å¦‚æœæœ‰åˆå§‹æ¶ˆæ¯ä¸”æ²¡æœ‰å…¶ä»–æ¶ˆæ¯ï¼Œæ›´æ–°åˆå§‹æ¶ˆæ¯
            if (chat.initialMessage && chat.messages.length === 0) {
                renderMessages();
            }
            
            renderChatTabs();
            elements.roleModal.style.display = 'none';
            state.isCreatingNewChat = false;
            saveToSessionStorage();
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // åˆå§‹åŒ–è§’è‰²è®¾ç½®ä¿å­˜æŒ‰é’®
        document.getElementById('saveRole').addEventListener('click', saveRoleSettings);
        
        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html>